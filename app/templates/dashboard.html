<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>LogWatch Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b0f17; color:#e6e6e6; }
    header { padding:16px 20px; background:#121a2a; border-bottom:1px solid #22314f; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:22px; }
    header .links a { margin-left:10px; padding:6px 10px; border-radius:10px; border:1px solid #2b3b60; background:#0f1626; color:#9ad; text-decoration:none; font-size:13px; }
    header .links a:hover { filter:brightness(1.15); }

    .container { padding:16px; }
    .card { background:#121a2a; border:1px solid #22314f; border-radius:14px; padding:14px; margin-bottom:14px; }
    .card h3 { margin:0 0 10px; font-size:16px; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    select, button, input { background:#0f1626; color:#e6e6e6; border:1px solid #2b3b60; border-radius:10px; padding:8px 10px; cursor:pointer; }
    input { cursor:text; }
    button:hover { filter:brightness(1.15); }
    .kpi { display:flex; gap:12px; margin-top:10px; flex-wrap:wrap; align-items:flex-start; }
    .kpi .box { background:#0f1626; border:1px solid #22314f; border-radius:12px; padding:10px 14px; min-width:160px; }
    .kpi .num { font-size:22px; font-weight:bold; }
    .grid { display:grid; grid-template-columns: 1.2fr 1fr; gap:14px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { border-bottom:1px solid #22314f; padding:8px; text-align:left; vertical-align:top; }
    th { color:#b9c3d6; }
    .right { text-align:right; }
    .chip { padding:4px 8px; border-radius:999px; background:#0f1626; border:1px solid #2b3b60; font-size:12px; display:inline-block; margin:2px 6px 0 0; }
    .small { font-size:12px; color:#9aa4b2; }
    canvas { max-height:280px; }

    .titleLink { color:#9ad; text-decoration:none; }
    .titleLink:hover { text-decoration:underline; }

    .pill { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #22314f; background:#0f1626; font-size:12px; }
    .ok { color:#b7ffb4; }
    .err { color:#ffb4b4; }
    pre { margin:0; white-space:pre-wrap; word-break:break-word; background:#0b0f17; border:1px solid #22314f; border-radius:12px; padding:10px; font-size:12px; }
  </style>
</head>

<body>
<header>
  <h1>LogWatch Dashboard</h1>
  <div class="links">
    <a href="/api/ingest/upload" target="_blank">Upload</a>
    <a href="/discover">Discover</a>
    <a href="/alerts">Alerts</a>
    <a href="/rules">Rules</a>
  </div>
</header>

<div class="container">

  <div class="card">
    <h3>Kontroller</h3>
    <div class="controls">
      <label class="small">Zaman (saat):</label>
      <select id="hours">
        <option value="1">1</option>
        <option value="6">6</option>
        <option value="12">12</option>
        <option value="24" selected>24</option>
        <option value="48">48</option>
      </select>

      <button id="refreshBtn">Yenile</button>

      <button id="runOnceBtn">Alarm Motoru (Run)</button>
      <span class="small" id="runOnceStatus"></span>
    </div>

    <!-- ✅ Dashboard Ack/Close NOTE -->
    <div class="controls" style="margin-top:10px;">
      <label class="small" for="dashNote">Ack/Close Notu:</label>
      <input id="dashNote" placeholder="opsiyonel not..." style="min-width:320px; flex:1;">
      <span class="small" id="dashNoteStatus"></span>
    </div>

    <div class="kpi">
      <div class="box">
        <div class="small">Toplam Log</div>
        <div class="num" id="totalLogs">-</div>
      </div>
      <div class="box">
        <div class="small">Open Alarm</div>
        <div class="num" id="openAlerts">-</div>
        <div class="small" id="openSevChips" style="margin-top:6px;"></div>
      </div>
      <div class="box">
        <div class="small">Range</div>
        <div class="small" id="rangeText">-</div>
      </div>
      <div class="box">
        <div class="small">Parse Status</div>
        <div class="small" id="parseChips">-</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Run Rules (Manual)</h3>
    <div class="controls">
      <label class="small">minutes:</label>
      <select id="rr_minutes">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="15">15</option>
        <option value="30">30</option>
        <option value="60">60</option>
      </select>

      <label class="small" style="display:flex; gap:8px; align-items:center;">
        <input type="checkbox" id="rr_use_latest" checked>
        use_latest
      </label>

      <label class="small" style="display:flex; gap:8px; align-items:center;">
        <input type="checkbox" id="rr_debug">
        debug
      </label>

      <button id="rr_runBtn">Run</button>
      <button id="rr_openAlertsBtn" onclick="window.open('/api/alerts?status=open','_blank')">Open Alerts JSON</button>

      <span class="small" id="rr_status"></span>
    </div>

    <div id="rr_summary" style="margin-top:12px; display:none;">
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <span class="pill">total_events_in_window: <b id="rr_total">-</b></span>
        <span class="pill">rules_checked: <b id="rr_rules">-</b></span>
        <span class="pill">matches_found: <b id="rr_matches">-</b></span>
        <span class="pill">alerts_created: <b id="rr_created">-</b></span>
        <span class="pill">errors: <b id="rr_errors">-</b></span>
      </div>

      <details style="margin-top:10px;">
        <summary style="cursor:pointer; color:#9ad; font-size:13px; padding:6px 10px; border:1px solid #2b3b60; border-radius:10px; background:#0f1626; display:inline-block;">
          Raw Response
        </summary>
        <div style="margin-top:10px;">
          <pre id="rr_raw"></pre>
        </div>
      </details>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Log Yoğunluğu (Time Series)</h3>
      <canvas id="volumeChart"></canvas>
    </div>

    <div class="card">
      <h3>Top Services</h3>
      <table>
        <thead><tr><th>Service</th><th class="right">Count</th></tr></thead>
        <tbody id="servicesBody"></tbody>
      </table>
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <h3>Top Source IP</h3>
      <table>
        <thead><tr><th>IP</th><th class="right">Count</th></tr></thead>
        <tbody id="ipsBody"></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Open Alarmlar</h3>
      <table>
        <thead>
          <tr>
            <th>Last Seen</th>
            <th>Title</th>
            <th>Key</th>
            <th class="right">Hit</th>
            <th>Aksiyon</th>
          </tr>
        </thead>
        <tbody id="alertsBody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
  const hoursEl = document.getElementById("hours");
  const refreshBtn = document.getElementById("refreshBtn");
  const runOnceBtn = document.getElementById("runOnceBtn");
  const runOnceStatus = document.getElementById("runOnceStatus");

  const totalLogsEl = document.getElementById("totalLogs");
  const openAlertsEl = document.getElementById("openAlerts");
  const rangeTextEl = document.getElementById("rangeText");
  const openSevChipsEl = document.getElementById("openSevChips");
  const parseChipsEl = document.getElementById("parseChips");

  const servicesBody = document.getElementById("servicesBody");
  const ipsBody = document.getElementById("ipsBody");
  const alertsBody = document.getElementById("alertsBody");

  // Dashboard note UI
  const dashNoteEl = document.getElementById("dashNote");
  const dashNoteStatusEl = document.getElementById("dashNoteStatus");

  // Runner UI
  const rrMinutesEl = document.getElementById("rr_minutes");
  const rrUseLatestEl = document.getElementById("rr_use_latest");
  const rrDebugEl = document.getElementById("rr_debug");
  const rrRunBtn = document.getElementById("rr_runBtn");
  const rrStatusEl = document.getElementById("rr_status");
  const rrSummaryEl = document.getElementById("rr_summary");
  const rrTotalEl = document.getElementById("rr_total");
  const rrRulesEl = document.getElementById("rr_rules");
  const rrMatchesEl = document.getElementById("rr_matches");
  const rrCreatedEl = document.getElementById("rr_created");
  const rrErrorsEl = document.getElementById("rr_errors");
  const rrRawEl = document.getElementById("rr_raw");

  let volumeChart = null;

  async function fetchJSON(url, opts={}) {
    const finalOpts = Object.assign({ credentials: "include" }, opts);
    const r = await fetch(url, finalOpts);
    const text = await r.text();
    let js = null;
    try { js = JSON.parse(text); } catch {}
    if (!r.ok) throw new Error(js?.error ? (typeof js.error === "string" ? js.error : JSON.stringify(js.error)) : text);
    return js ?? {};
  }

  function clear(el) { while (el.firstChild) el.removeChild(el.firstChild); }

  function renderChips(container, items){
    container.innerHTML = "";
    if(!items || items.length === 0){
      container.textContent = "-";
      return;
    }
    items.forEach(it=>{
      const span = document.createElement("span");
      span.className = "chip";
      span.textContent = it;
      container.appendChild(span);
    });
  }

  function esc(s){
    if (s === null || s === undefined) return "";
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function setRunnerStatus(msg, ok=true){
    rrStatusEl.textContent = msg || "";
    rrStatusEl.className = "small " + (ok ? "ok" : "err");
  }

  function setDashNoteStatus(msg, ok=true){
    dashNoteStatusEl.textContent = msg || "";
    dashNoteStatusEl.className = "small " + (ok ? "ok" : "err");
    if (msg){
      setTimeout(()=>{ dashNoteStatusEl.textContent = ""; dashNoteStatusEl.className="small"; }, 2200);
    }
  }

  async function loadDashboard() {
    const hours = hoursEl.value;
    const bucket = Number(hours) <= 6 ? "minute" : "hour";

    const summary = await fetchJSON(`/api/metrics/summary?hours=${hours}`);
    totalLogsEl.textContent = summary.total ?? "-";
    rangeTextEl.textContent = (summary.range?.from ?? "-") + " → " + (summary.range?.to ?? "-");

    const ps = (summary.parse_status_counts || []).slice(0, 6).map(x => `ps=${x.parse_status}: ${x.count}`);
    renderChips(parseChipsEl, ps);

    const ts = await fetchJSON(`/api/metrics/timeseries?hours=${hours}&bucket=${bucket}`);
    const labels = (ts.data || []).map(x => new Date(x.t).toLocaleString());
    const values = (ts.data || []).map(x => x.c);

    if (!volumeChart) {
      volumeChart = new Chart(document.getElementById("volumeChart"), {
        type: "line",
        data: { labels, datasets: [{ label: "Log Count", data: values }] },
        options: { responsive: true }
      });
    } else {
      volumeChart.data.labels = labels;
      volumeChart.data.datasets[0].data = values;
      volumeChart.update();
    }

    clear(servicesBody);
    (summary.top_services || []).forEach(s => {
      servicesBody.insertAdjacentHTML("beforeend",
        `<tr><td>${esc(s.service)}</td><td class="right">${esc(s.count)}</td></tr>`
      );
    });

    clear(ipsBody);
    (summary.top_ips || []).forEach(ip => {
      ipsBody.insertAdjacentHTML("beforeend",
        `<tr><td>${esc(ip.src_ip)}</td><td class="right">${esc(ip.count)}</td></tr>`
      );
    });

    const openStats = await fetchJSON(`/api/alerts/?status=open&stats=1`);
    openAlertsEl.textContent = openStats.count ?? "-";
    const sev = openStats.severity_counts || {};
    const sevChips = Object.keys(sev).map(k => `${k}: ${sev[k]}`);
    renderChips(openSevChipsEl, sevChips);

    const alerts = await fetchJSON(`/api/alerts/?status=open`);
    const list = alerts.data || [];

    clear(alertsBody);
    list.forEach(a => {
      alertsBody.insertAdjacentHTML("beforeend", `
        <tr>
          <td class="small">${a.last_seen ? new Date(a.last_seen).toLocaleString() : "-"}</td>

          <td>
            <a class="titleLink" href="/alerts/${a.id}">
              <b>${esc(a.title || "-")}</b>
            </a>
            <div class="small">${esc(a.severity || "")} · ${esc(a.status || "")}</div>
          </td>

          <td><span class="chip">${esc(a.group_key || "global")}</span></td>
          <td class="right">${esc(a.hit_count || 1)}</td>
          <td>
            <button onclick="ack(${a.id})">Ack</button>
            <button onclick="closeAlert(${a.id})">Close</button>
          </td>
        </tr>
      `);
    });
  }

  // ✅ Dashboard: note ile ack/close
  function getNote(){
    const s = (dashNoteEl.value || "").trim();
    return s.length ? s : null;
  }

  async function ack(id) {
    try{
      const note = getNote();
      await fetchJSON(`/api/alerts/${id}/ack`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ note })
      });
      setDashNoteStatus("Ack OK", true);
      loadDashboard();
    }catch(e){
      setDashNoteStatus("Ack hata: " + e.message, false);
      alert(e.message);
    }
  }

  async function closeAlert(id) {
    try{
      const note = getNote();
      await fetchJSON(`/api/alerts/${id}/close`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ note })
      });
      setDashNoteStatus("Close OK", true);
      loadDashboard();
    }catch(e){
      setDashNoteStatus("Close hata: " + e.message, false);
      alert(e.message);
    }
  }

  refreshBtn.onclick = loadDashboard;

  async function runRules(){
    rrRunBtn.disabled = true;
    setRunnerStatus("çalışıyor...", true);

    const minutes = parseInt(rrMinutesEl.value || "10", 10);
    const useLatest = rrUseLatestEl.checked;
    const debug = rrDebugEl.checked;

    const qs = new URLSearchParams();
    if (useLatest) qs.set("use_latest","1");
    if (debug) qs.set("debug","1");

    try{
      const res = await fetchJSON(`/api/alerts/run?${qs.toString()}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ minutes })
      });

      rrSummaryEl.style.display = "";
      rrTotalEl.textContent = res.total_events_in_window ?? "-";

      const eng = res.engine || {};
      rrRulesEl.textContent = eng.rules_checked ?? "-";
      rrMatchesEl.textContent = eng.matches_found ?? "-";
      rrCreatedEl.textContent = eng.alerts_created ?? "-";
      rrErrorsEl.textContent = eng.errors ?? "-";

      rrRawEl.textContent = JSON.stringify(res, null, 2);

      setRunnerStatus("ok", true);
      await loadDashboard();
    }catch(e){
      setRunnerStatus("hata: " + e.message, false);
      alert(e.message);
    }finally{
      rrRunBtn.disabled = false;
    }
  }

  rrRunBtn.onclick = runRules;

  runOnceBtn.onclick = async () => {
    runOnceStatus.textContent = "çalışıyor...";
    try {
      await runRules();
      runOnceStatus.textContent = "ok";
    } catch (e) {
      runOnceStatus.textContent = "hata";
    }
  };

  loadDashboard();
</script>
</body>
</html>
