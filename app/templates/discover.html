<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Discover - LogWatch</title>

  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#0b0f17; color:#e6e6e6; }
    header { padding:14px 18px; background:#121a2a; border-bottom:1px solid #22314f; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:18px; }
    header a { color:#9ad; text-decoration:none; padding:6px 10px; border:1px solid #2b3b60; border-radius:10px; background:#0f1626; font-size:13px; }
    .wrap { padding:14px; }
    .card { background:#121a2a; border:1px solid #22314f; border-radius:14px; padding:12px; margin-bottom:12px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label { font-size:12px; color:#9aa4b2; }
    input, select, button {
      background:#0f1626; color:#e6e6e6; border:1px solid #2b3b60; border-radius:10px;
      padding:8px 10px; font-size:13px;
    }
    button { cursor:pointer; }
    button:hover { filter:brightness(1.12); }
    .grid { display:grid; grid-template-columns: 1.2fr 0.8fr; gap:12px; }
    table { width:100%; border-collapse:collapse; font-size:12.5px; }
    th, td { border-bottom:1px solid #22314f; padding:8px; vertical-align:top; }
    th { color:#b9c3d6; text-align:left; font-weight:600; }
    .muted { color:#9aa4b2; font-size:12px; }
    .chip { display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid #2b3b60; background:#0f1626; font-size:12px; }
    .click { cursor:pointer; }
    .click:hover { background:#0f1626; }
    pre { white-space:pre-wrap; word-break:break-word; margin:0; font-family: ui-monospace, monospace; font-size:12px; }
    .pager { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:10px; }
    .small { font-size:12px; color:#9aa4b2; }
  </style>
</head>

<body>
<header>
  <h1>Discover</h1>
  <div class="row">
    <a href="/dashboard">Dashboard</a>
    <a href="/api/ingest/upload" target="_blank">Upload</a>
  </div>
</header>

<div class="wrap">

  <!-- FILTERS -->
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div style="font-weight:700;">Filtreler</div>
        <div class="muted">Elastic Discover benzeri log inceleme ekranı</div>
      </div>
      <div class="row">
        <button id="btnSearch">Ara</button>
        <button id="btnReset">Sıfırla</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Hours</label><br/>
        <select id="hours">
          <option value="1">1</option>
          <option value="6">6</option>
          <option value="12">12</option>
          <option value="24" selected>24</option>
          <option value="48">48</option>
          <option value="168">7 gün</option>
        </select>
      </div>

      <div>
        <label>Service</label><br/>
        <input id="service" placeholder="nginx / auth / suricata">
      </div>

      <div>
        <label>Level</label><br/>
        <select id="level">
          <option value="">(hepsi)</option>
          <option value="INFO">INFO</option>
          <option value="WARN">WARN</option>
          <option value="ERROR">ERROR</option>
        </select>
      </div>

      <div>
        <label>Source IP</label><br/>
        <input id="src_ip" placeholder="1.2.3.4">
      </div>

      <div>
        <label>HTTP Status</label><br/>
        <input id="http_status" placeholder="200 / 404 / 500">
      </div>

      <div style="flex:1; min-width:240px;">
        <label>Text Search</label><br/>
        <input id="q" placeholder="login failed, /admin, sql injection..." style="width:100%;">
      </div>

      <div>
        <label>Page Size</label><br/>
        <select id="limit">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
          <option value="200">200</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div class="chip" id="totalChip">Total: -</div>
      <div class="chip" id="pageChip">Page: 1</div>
      <div class="muted" id="statusText"></div>
    </div>
  </div>

  <div class="grid">

    <!-- TABLE -->
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Level</th>
            <th>Service</th>
            <th>Src IP</th>
            <th>Message</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="pager">
        <button id="prevBtn">◀ Prev</button>
        <div class="small" id="rangeInfo">-</div>
        <button id="nextBtn">Next ▶</button>
      </div>
    </div>

    <!-- DETAIL -->
    <div class="card">
      <div style="font-weight:700; margin-bottom:6px;">Detay</div>

      <div class="row" style="margin-bottom:8px;">
        <div class="chip" id="d_level">level:-</div>
        <div class="chip" id="d_service">service:-</div>
        <div class="chip" id="d_ip">src_ip:-</div>
        <div class="chip" id="d_status">http:-</div>
      </div>

      <div class="card" style="background:#0f1626;">
        <div class="small">Message</div>
        <pre id="d_msg">-</pre>
      </div>

      <div class="card" style="margin-top:8px; background:#0f1626;">
        <div class="small">Raw</div>
        <pre id="d_raw">-</pre>
      </div>

      <div class="card" style="margin-top:8px; background:#0f1626;">
        <div class="small">Extra JSON</div>
        <pre id="d_extra">-</pre>
      </div>
    </div>

  </div>
</div>

<script>
let page = 1;

const el = id => document.getElementById(id);

async function load() {
  el("statusText").textContent = "yükleniyor...";
  el("tbody").innerHTML = "";

  const size = Number(el("limit").value);

  const params = new URLSearchParams({
    hours: el("hours").value,
    page,
    size
  });

  ["service","level","src_ip","http_status","q"].forEach(k=>{
    if(el(k).value.trim()) params.set(k, el(k).value.trim());
  });

  const res = await fetch("/api/search?" + params.toString()).then(r=>r.json());

  const items = res.data || [];
  const total = res.total || 0;

  el("totalChip").textContent = "Total: " + total;
  el("pageChip").textContent = "Page: " + page;

  const start = (page-1)*size + 1;
  const end = start + items.length - 1;
  el("rangeInfo").textContent = `${start}-${end} / ${total}`;

  items.forEach(it=>{
    const tr = document.createElement("tr");
    tr.className = "click";
    tr.innerHTML = `
      <td class="muted">${new Date(it.ingest_time).toLocaleString()}</td>
      <td><span class="chip">${it.level||"-"}</span></td>
      <td>${it.service||"-"}</td>
      <td>${it.src_ip||"-"}</td>
      <td>${(it.message||"").slice(0,140)}</td>
    `;
    tr.onclick = ()=>showDetail(it);
    el("tbody").appendChild(tr);
  });

  if(items[0]) showDetail(items[0]);

  el("prevBtn").disabled = page<=1;
  el("nextBtn").disabled = page*size>=total;
  el("statusText").textContent = "ok";
}

function showDetail(it){
  el("d_level").textContent = "level: " + (it.level||"-");
  el("d_service").textContent = "service: " + (it.service||"-");
  el("d_ip").textContent = "src_ip: " + (it.src_ip||"-");
  el("d_status").textContent = "http: " + (it.http_status||"-");
  el("d_msg").textContent = it.message || "-";
  el("d_raw").textContent = it.raw_text || "-";
  try {
    el("d_extra").textContent = it.extra_json ? JSON.stringify(JSON.parse(it.extra_json),null,2) : "-";
  } catch {
    el("d_extra").textContent = it.extra_json || "-";
  }
}

el("btnSearch").onclick = ()=>{ page=1; load(); };
el("btnReset").onclick = ()=>{ page=1; ["service","level","src_ip","http_status","q"].forEach(k=>el(k).value=""); load(); };
el("prevBtn").onclick = ()=>{ if(page>1){ page--; load(); }};
el("nextBtn").onclick = ()=>{ page++; load(); };

load();
</script>

</body>
</html>
