<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Alert Detail | LogWatch</title>

  <style>
    :root{
      --bg:#0b0f17;
      --panel:#121a2a;
      --panel2:#0f1626;
      --border:#22314f;
      --text:#e6e6e6;
      --muted:#9aa4b2;
      --link:#9ad;
      --good:#3ddc97;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{ box-sizing:border-box; }
    body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    header { padding:16px 20px; background:var(--panel); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:14px; }
    header h1 { margin:0; font-size:18px; letter-spacing:.2px; }
    header .links a { margin-left:10px; padding:6px 10px; border-radius:10px; border:1px solid #2b3b60; background:var(--panel2); color:var(--link); text-decoration:none; font-size:13px; }
    header .links a:hover { filter:brightness(1.08); }

    .container { padding:18px; max-width:1200px; margin:0 auto; }
    .grid { display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .card { background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .card h2 { margin:0 0 10px; font-size:15px; color:#d7e2ff; }
    .muted { color:var(--muted); }
    .row { display:flex; flex-wrap:wrap; gap:10px 14px; align-items:center; }
    .kv { display:flex; gap:8px; align-items:baseline; }
    .k { color:var(--muted); font-size:12px; }
    .v { font-size:13px; }
    .pill { font-size:12px; padding:3px 10px; border-radius:999px; border:1px solid #2b3b60; background:var(--panel2); }
    .pill.good{ border-color:rgba(61,220,151,.35); }
    .pill.warn{ border-color:rgba(255,204,102,.35); }
    .pill.bad { border-color:rgba(255,107,107,.35); }

    .table { width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid var(--border); }
    .table th, .table td { padding:10px 10px; font-size:13px; border-bottom:1px solid var(--border); vertical-align:top; }
    .table th { background:rgba(15,22,38,.7); color:#cfe0ff; text-align:left; font-weight:600; }
    .table tr:last-child td{ border-bottom:none; }
    .table tr:hover td{ background:rgba(15,22,38,.35); cursor:pointer; }

    .expand { display:none; padding:10px; border-top:1px dashed #2b3b60; background:rgba(15,22,38,.35); }
    .pre { white-space:pre-wrap; word-break:break-word; font-family:var(--mono); font-size:12px; margin:0; color:#dbe7ff; }
    .pre.muted { color:#b7c2d6; }

    .statusline { display:flex; justify-content:space-between; gap:10px; align-items:center; margin-bottom:10px; }
    .right { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .err { color: var(--bad); font-size:13px; }
    .small { font-size:12px; }
  </style>
</head>

<body>
<header>
  <div>
    <h1>LogWatch • Alert Detail</h1>
    <div class="muted small">Read-only görüntüleme.</div>
  </div>
  <div class="links">
    <a href="/dashboard">Dashboard</a>
    <a href="/alerts">Alerts</a>
    <a href="/discover">Discover</a>
  </div>
</header>

<div class="container">
  <div id="topError" class="err" style="display:none;"></div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="statusline">
        <h2 style="margin:0;">Alert</h2>
        <div class="right">
          <span id="pillStatus" class="pill">status</span>
          <span id="pillSev" class="pill">severity</span>
        </div>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <div class="kv"><div class="k">ID</div><div id="aId" class="v">-</div></div>
        <div class="kv"><div class="k">Title</div><div id="aTitle" class="v">-</div></div>
        <div class="kv"><div class="k">Rule</div><div id="aRule" class="v">-</div></div>
        <div class="kv"><div class="k">Group</div><div id="aGroup" class="v">-</div></div>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <div class="kv"><div class="k">First Seen</div><div id="aFirst" class="v">-</div></div>
        <div class="kv"><div class="k">Last Seen</div><div id="aLast" class="v">-</div></div>
        <div class="kv"><div class="k">Hit Count</div><div id="aHits" class="v">-</div></div>
        <div class="kv"><div class="k">Event Count</div><div id="aEventCount" class="v">-</div></div>
      </div>

      <h2 style="margin-top:14px;">Related Events</h2>
      <table class="table" id="eventsTable">
        <thead>
          <tr>
            <th style="width:170px;">Time</th>
            <th style="width:90px;">Service</th>
            <th style="width:90px;">Level</th>
            <th>Message</th>
          </tr>
        </thead>
        <tbody id="eventsTbody">
          <tr><td colspan="4" class="muted">Yükleniyor…</td></tr>
        </tbody>
      </table>

      <div class="muted small" style="margin-top:10px;">
        Satıra tıkla → raw/parsed detay açılır.
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card" style="margin-bottom:14px;">
        <h2>Details JSON</h2>
        <pre id="detailsJson" class="pre muted">{}</pre>
      </div>

      <div class="card">
        <h2>Audit Trail</h2>
        <div class="muted small" style="margin-bottom:10px;">
          Bu alan yalnızca görüntüleme içindir.
        </div>
        <pre id="auditJson" class="pre muted">[]</pre>
      </div>
    </div>
  </div>
</div>

<script>
  const alertId = (() => {
    const parts = window.location.pathname.split("/").filter(Boolean);
    return parts[parts.length - 1];
  })();

  function showTopError(msg){
    const el = document.getElementById("topError");
    el.textContent = msg || "Hata";
    el.style.display = "block";
  }

  function pill(el, text, kind){
    el.textContent = text ?? "-";
    el.classList.remove("good","warn","bad");
    if(kind) el.classList.add(kind);
  }

  function sevKind(sev){
    const s = String(sev || "").toLowerCase();
    if (s === "high" || s === "critical") return "bad";
    if (s === "medium" || s === "warn") return "warn";
    return "good";
  }

  function statusKind(st){
    const s = String(st || "").toLowerCase();
    if (s === "open") return "warn";
    if (s === "closed") return "good";
    if (s === "ack") return "warn";
    return "";
  }

  function fmt(v){
    if(v === null || v === undefined) return "-";
    return String(v);
  }

  function safeJson(v, fallback){
    try{
      if (typeof v === "string") return JSON.parse(v);
      if (typeof v === "object") return v ?? fallback;
      return fallback;
    }catch(e){
      return fallback;
    }
  }

  function buildEventRow(e){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${fmt(e.event_time || e.timestamp || e.ingest_time)}</td>
      <td>${fmt(e.service)}</td>
      <td>${fmt(e.level)}</td>
      <td>${fmt(e.message)}</td>
    `;

    const expandTr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 4;
    const expand = document.createElement("div");
    expand.className = "expand";

    const raw = safeJson(e.raw_json ?? e.raw ?? null, null);
    const parsed = safeJson(e.parsed_json ?? e.parsed ?? null, null);

    const rawText = raw ? JSON.stringify(raw, null, 2) : fmt(e.raw_text || e.raw_line || "");
    const parsedText = parsed ? JSON.stringify(parsed, null, 2) : (e.parsed_text ? fmt(e.parsed_text) : "");

    expand.innerHTML = `
      <div class="muted small" style="margin-bottom:6px;">Raw</div>
      <pre class="pre">${rawText ? rawText : "-"}</pre>
      <div class="muted small" style="margin:10px 0 6px;">Parsed</div>
      <pre class="pre muted">${parsedText ? parsedText : "-"}</pre>
    `;
    td.appendChild(expand);
    expandTr.appendChild(td);

    tr.addEventListener("click", () => {
      const isOpen = expand.style.display === "block";
      expand.style.display = isOpen ? "none" : "block";
      expandTr.style.display = isOpen ? "none" : "table-row";
    });

    expandTr.style.display = "none";
    return { tr, expandTr, expand };
  }

  async function loadAlert(){
    const res = await fetch(`/api/alerts/${encodeURIComponent(alertId)}`, { credentials: "include" });
    const js = await res.json().catch(() => null);
    if(!res.ok || !js || js.success === false){
      throw new Error((js && js.error) ? js.error : `Alert yüklenemedi (${res.status})`);
    }
    return js;
  }

  async function render(){
    try{
      const data = await loadAlert();
      const a = data.alert || data;

      document.getElementById("aId").textContent = fmt(a.id);
      document.getElementById("aTitle").textContent = fmt(a.title);
      document.getElementById("aRule").textContent = fmt(a.rule_id ?? a.rule_name ?? "-");
      document.getElementById("aGroup").textContent = fmt(a.group_key ?? "-");
      document.getElementById("aFirst").textContent = fmt(a.first_seen);
      document.getElementById("aLast").textContent = fmt(a.last_seen);
      document.getElementById("aHits").textContent = fmt(a.hit_count);
      document.getElementById("aEventCount").textContent = fmt(a.event_count);

      pill(document.getElementById("pillStatus"), fmt(a.status), statusKind(a.status));
      pill(document.getElementById("pillSev"), fmt(a.severity), sevKind(a.severity));

      // Backend: details -> dict (a.details) döndürüyorsun.
      // Yine de string gelirse diye safeJson bıraktık.
      const detailsObj = safeJson(a.details_json ?? a.details, {});
      document.getElementById("detailsJson").textContent = JSON.stringify(detailsObj || {}, null, 2);

      // Audit: details.audit içinden oku (append_audit burada tutuluyordu)
      const auditArr = (detailsObj && Array.isArray(detailsObj.audit)) ? detailsObj.audit : [];
      document.getElementById("auditJson").textContent = JSON.stringify(auditArr, null, 2);

      const evs = data.related_events || data.events || [];
      const tbody = document.getElementById("eventsTbody");
      tbody.innerHTML = "";
      if(!evs.length){
        tbody.innerHTML = `<tr><td colspan="4" class="muted">Event bulunamadı.</td></tr>`;
        return;
      }

      for(const e of evs){
        const { tr, expandTr } = buildEventRow(e);
        tbody.appendChild(tr);
        tbody.appendChild(expandTr);
      }
    }catch(err){
      showTopError(err.message || String(err));
      const tbody = document.getElementById("eventsTbody");
      if(tbody) tbody.innerHTML = `<tr><td colspan="4" class="muted">Yükleme hatası.</td></tr>`;
    }
  }

  render();
</script>
</body>
</html>
